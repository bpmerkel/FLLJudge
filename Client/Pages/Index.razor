@page "/"
@inject Task<Model> _getModel
@inject IDialogService DialogService

<PageTitle>FLL Judge Comments</PageTitle>

<MudLayout>
    <MudMainContent Class="pt-0">
        <MudAppBar Color="Color.Primary" Fixed="false" Dense="true">
            <MudText Typo="Typo.h4">FLL Judge Comments App</MudText>
            <MudSpacer />
            <MudTooltip Text="Clear all selections">
                <MudButton Variant="Variant.Text" StartIcon="@Icons.Material.Filled.ClearAll" OnClick="@DoReset" Color="Color.Error">Clear All</MudButton>
            </MudTooltip>
            <MudButton Variant="Variant.Text" StartIcon="@Icons.Material.Filled.Help" Color="Color.Warning" @onclick="OpenWelcomeDialog">Welcome</MudButton>
        </MudAppBar>

        @if (model != null)
        {
            <MudTabs Elevation="4" Rounded="true" Centered="true" Color="@Color.Secondary" ApplyEffectsToContainer="true" AlwaysShowScrollButtons="true">
                <ChildContent>
                    @foreach (var area in model.Areas)
                    {
                        <MudTabPanel Text="@area.Name" BadgeDot="@(!area.Comments.Any(c => c.Selected))" BadgeData="@area.Comments.Count(c => c.Selected)" BadgeColor="@(area.Comments.Any(c => c.Selected) ? Color.Error : Color.Transparent)">
                            <MudChipSet MultiSelection="true" Filter="true" @bind-SelectedChips="selected">
                                @foreach (var tag in area.Tags)
                                {
                                    <MudChip Text="@tag" Variant="Variant.Text" Color="Color.Warning">@tag</MudChip>
                                }
                            </MudChipSet>
                            <MudList Clickable="true" Dense="true" @bind-SelectedItem="selectedItem" Color="Color.Primary">
                                @foreach (var section in area.Comments.GroupBy(c => c.Section).Select(g => new { section = g.Key, comments = g.ToList() }))
                                {
                                    <MudListItem Expanded="true" InitiallyExpanded="true">
                                        <ChildContent>
                                            <MudText Typo="Typo.h5" Color="Color.Secondary">@getSectionName(section.section)</MudText>
                                        </ChildContent>
                                        <NestedList>
                                            @foreach (var comment in section.comments)
                                            {
                                                <MudListItem>
                                                    <MudCheckBox @bind-Checked="comment.Selected" Dense="true" Color="@Color.Primary">
                                                        <MudHighlighter Class="mud-warning-text"
                                                                        Style="background-color:transparent;font-weight:bold;font-size:18pt"
                                                                        Text="@comment.Text"
                                                                        UntilNextBoundary="true"
                                                                        CaseSensitive="false"
                                                                        Markup="true"
                                                                        HighlightedTexts="@searchTerms" />
                                                    </MudCheckBox>
                                                </MudListItem>
                                            }
                                        </NestedList>
                                    </MudListItem>
                                }
                            </MudList>
                        </MudTabPanel>
                    }
                </ChildContent>
            </MudTabs>
        }
        else
        {
            <MudProgressCircular Color="Color.Primary" Indeterminate="true" Size="Size.Large" />
        }
    </MudMainContent>
</MudLayout>

@code
{
    Model model;
    MudChip[] selected;
    MudListItem selectedItem;
    IEnumerable<string> searchTerms => selected == null
        ? new string[] { }
        : selected.Select(c => c.Text);

    protected override async Task OnInitializedAsync()
    {
        model = await _getModel;
        StateHasChanged();
    }

    protected override Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            OpenWelcomeDialog();
        }
        return base.OnAfterRenderAsync(firstRender);
    }

    private void OpenWelcomeDialog() => DialogService.Show<WelcomeDialog>("Welcome", new DialogOptions
        {
            CloseButton = true,
            DisableBackdropClick = true,
            NoHeader = false,
            Position = DialogPosition.Center,
            CloseOnEscapeKey = true
        });

    string getSectionName(Comment.Sections section) => section switch
    {
        Comment.Sections.ThinkAbout => "Think about...",
        Comment.Sections.GreatJob => "Great job...",
        _ => section.ToString()
    };

    void DoReset(MouseEventArgs e)
    {
        // perform a reset by clearing all selected comments and unchecking chips
        model.Areas.ForEach(a =>
        {
            a.Comments.ForEach(c => c.Selected = false);
        });

        selected = new MudChip[] { };
        selectedItem = null;
        StateHasChanged();
    }
}